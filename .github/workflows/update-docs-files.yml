name: Update Markprompt Data

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  update_data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
        with:
          ref: main
      - name: Get files
        id: get_files
        run: |
          curl -s https://raw.githubusercontent.com/SovereignCloudStack/docs-page/main/docs.package.json > docs.package.json
          jq -c '.[]' docs.package.json | while read i; do
            repo=$(echo "$i" | jq -r '.repo')
            source_dir=$(echo "$i" | jq -r '.source')
            target_dir=$(echo "$i" | jq -r '.target')
            label=$(echo "$i" | jq -r '.label')
            repo_path="$HOME/$repo"
            target_path="$GITHUB_WORKSPACE"
            if [ ! -d "$repo_path" ]; then
              git clone "https://github.com/$repo.git" "$repo_path"
            else
              cd "$repo_path"
              git pull
              cd "$GITHUB_WORKSPACE"
            fi
            if [ -z "$label" ]; then
              label=$(basename "$source_dir")
            fi
            mkdir -p "$target_path/$target_dir/$label"
            cp -R "$repo_path/$source_dir/." "$target_path/$target_dir/$label/"
          done
      - name: Update README
        run: |
          echo "# Markprompt Data" > README.md
          echo "" >> README.md
          echo "This repository contains the following files:" >> README.md
          echo "" >> README.md
          find . -type f | grep -v README.md >> README.md
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update Markprompt Data"
          commit_options: "--no-verify"
